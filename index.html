<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Procesador de archivos de clientes - CRM</title>
  <!-- Fuente Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" 
        integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" 
        crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --clients-per-line: 6;
    }
    body {
      font-family: 'Poppins', sans-serif;
      margin: 20px;
    }
    #drop-area {
      border: 2px dashed #ccc;
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
      transition: border-color 0.3s;
    }
    #drop-area.highlight {
      border-color: purple;
    }
    #search-container {
      margin-bottom: 10px;
      text-align: right;
    }
    #search-input {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .category-header {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .category-icon {
      font-size: 1.2em;
    }
    .clients-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .client-block {
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      background-color: #aef39b;
      box-sizing: border-box;
      flex: 0 0 calc(100% / var(--clients-per-line) - 10px);
      transition: background-color 0.3s, transform 0.3s, opacity 0.3s;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .client-block.derivado {
      background-color: #ffe0b2;
    }
    .client-block p {
      margin: 2px 0;
    }
    .client-block:hover {
      transform: scale(1.02);
    }
    .client-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }
    .client-buttons button {
      margin-top: 0;
    }
    .client-buttons button:last-child {
      margin-left: auto;
    }
    .client-notes-container {
      margin-top: 10px;
    }
    .client-notes {
      border: 1px solid #ddd;
      padding: 5px;
      border-radius: 5px;
      min-height: 30px;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-y: auto;
      max-height: 100px;
      cursor: pointer;
      position: relative;
    }
    .note-timestamp {
      font-size: 0.7em;
      color: #777;
      display: block;
      text-align: right;
      margin-top: 5px;
    }
    button {
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      background-color: #6c63ff;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #5750d4;
    }
    h2 {
      border-bottom: 2px solid #ccc;
      padding-bottom: 5px;
      margin-top: 20px;
    }
    pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
      border-radius: 10px;
      position: relative;
    }
    .close-button {
      position: absolute;
      right: 10px;
      top: 5px;
      font-size: 24px;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
    }
    .close-button:hover {
      color: #000;
    }
  </style>
  <!-- Librería XLSX para leer archivos Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Firebase (versión 8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>
  <h1>Procesador de archivos de clientes - CRM</h1>
  <p>Arrastra y suelta un archivo o haz clic en el botón para seleccionar uno desde tu dispositivo.</p>
  <div id="drop-area">
    <p>Arrastra y suelta el archivo aquí</p>
    <p>o</p>
    <input type="file" id="file-input" accept=".xls,.xlsx,.html,.htm">
  </div>

  <div id="search-container">
    <input type="text" id="search-input" placeholder="Buscar por Nombre o DNI">
  </div>

  <div id="results"></div>

  <!-- Modal para edición de nota -->
  <div id="note-modal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h3>Editar Nota</h3>
      <textarea id="note-modal-textarea" rows="5" style="width:100%;"></textarea>
      <div id="note-modal-timestamp" style="font-size:0.8em; color:#777; margin-top:10px;"></div>
      <button id="note-modal-save">Guardar</button>
      <button id="note-modal-close">Cerrar</button>
    </div>
  </div>

  <script>
    // Inicialización de Firebase con tu configuración
    var firebaseConfig = {
      apiKey: "AIzaSyCkPL0qOB0maHD8U6F-lxD_Pq7xUpSPuhc",
      authDomain: "estadoclientes-146b02.firebaseapp.com",
      projectId: "estadoclientes-146b02",
      storageBucket: "estadoclientes-146b02.appspot.com", // Asegúrate de que este valor sea correcto
      messagingSenderId: "906681118562",
      appId: "1:906681118562:web:471770225b337781fa863b",
      measurementId: "G-BW86W5P717"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();

    // Objeto global para almacenar el estado de clientes (clave: DNI)
    let clientesEstado = {};

    // Función para cargar el estado desde Firestore
    function cargarEstado() {
      return db.collection("clientes").get()
        .then(querySnapshot => {
          clientesEstado = {};
          querySnapshot.forEach(doc => {
            const cliente = doc.data();
            if (cliente.DNI) {
              clientesEstado[cliente.DNI] = cliente;
            }
          });
        })
        .catch(err => {
          console.error("Error al cargar el estado:", err);
          clientesEstado = {};
        });
    }

    // Actualiza el estado de un cliente y lo guarda en Firestore
    function actualizarEstadoCliente(dni, newState) {
      clientesEstado[dni] = { ...getEstadoCliente(dni), ...newState, DNI: dni };
      db.collection("clientes").doc(dni).set(clientesEstado[dni], { merge: true })
        .then(() => { console.log("Estado actualizado para DNI:", dni); })
        .catch(err => { console.error("Error al actualizar estado para DNI:", dni, err); });
    }

    // Retorna el estado de un cliente o valores por defecto
    function getEstadoCliente(dni) {
      return clientesEstado[dni] || { copiado: "no", derivado: "no", nota: "", timestamp: "", DNI: dni };
    }

    // Funciones para manejar "derivado" y "copiado"
    function saveDerivedDni(dni) { actualizarEstadoCliente(dni, { derivado: "si" }); }
    function removeDerivedDni(dni) { actualizarEstadoCliente(dni, { derivado: "no" }); }
    function isDniDerived(dni) { return getEstadoCliente(dni).derivado === "si"; }
    function setCopiedState(dni, state) { actualizarEstadoCliente(dni, { copiado: state ? "si" : "no" }); }
    function isCopied(dni) { return getEstadoCliente(dni).copiado === "si"; }

    // Funciones para manejar notas
    function getNoteDataForDni(dni) {
      const estado = getEstadoCliente(dni);
      return { note: estado.nota || '', timestamp: estado.timestamp || '' };
    }
    function saveNotesForDni(dni, note) {
      if (note && note.trim() !== "") {
        const now = new Date();
        const timestamp = now.toLocaleDateString() + ' ' + now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        actualizarEstadoCliente(dni, { nota: note, timestamp: timestamp });
      } else {
        actualizarEstadoCliente(dni, { nota: "", timestamp: "" });
      }
    }

    // Esperamos a que el DOM se cargue completamente
    document.addEventListener('DOMContentLoaded', () => {

      // Manejo de arrastre y suelta
      const dropArea = document.getElementById('drop-area');
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
      });
      ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
      });
      ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
      });
      dropArea.addEventListener('drop', handleDrop, false);

      // Input de archivos
      const fileInput = document.getElementById('file-input');
      fileInput.addEventListener('change', (e) => {
        const files = e.target.files;
        handleFiles(files);
      });

      // Función para manejar el evento drop
      function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
      }

      // Función para procesar archivos
      function handleFiles(files) {
        if (files.length === 0) return;
        cargarEstado().then(() => {
          const file = files[0];
          const resultsContainer = document.getElementById('results');
          resultsContainer.innerHTML = '';
          const fileName = file.name.toLowerCase();
          if (fileName.endsWith('.xls') || fileName.endsWith('.xlsx')) {
            readExcel(file);
          } else if (fileName.endsWith('.html') || fileName.endsWith('.htm')) {
            readHtml(file);
          } else {
            alert('Formato de archivo no soportado.');
          }
        });
      }

      function readExcel(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const data = e.target.result;
          const workbook = XLSX.read(data, { type: 'binary', cellText: true });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const rawData = [];
          const range = XLSX.utils.decode_range(worksheet['!ref']);
          for (let r = range.s.r; r <= range.e.r; r++) {
            const row = [];
            for (let c = range.s.c; c <= range.e.c; c++) {
              const cellRef = XLSX.utils.encode_cell({ r: r, c: c });
              const cell = worksheet[cellRef];
              row.push(cell ? (cell.t === 'n' && cell.w ? cell.w : cell.v) : '');
            }
            rawData.push(row);
          }
          processData(rawData);
        };
        reader.onerror = function(err) {
          alert("Error al leer el archivo Excel.");
        };
        reader.readAsBinaryString(file);
      }

      function readHtml(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const htmlText = e.target.result;
          const parser = new DOMParser();
          const doc = parser.parseFromString(htmlText, 'text/html');
          const table = doc.querySelector('table');
          if (!table) {
            alert("No se encontró una tabla en el archivo HTML.");
            return;
          }
          const rows = [];
          table.querySelectorAll('tr').forEach(tr => {
            const row = [];
            tr.querySelectorAll('th, td').forEach(cell => row.push(cell.textContent.trim()));
            rows.push(row);
          });
          processData(rows);
        };
        reader.onerror = function(err) {
          alert("Error al leer el archivo HTML.");
        };
        reader.readAsText(file);
      }

      // Genera el texto a copiar para cada cliente
      function getClientCopyText(clientInfo) {
        let text = `Nombre: ${clientInfo.nombre}\n${clientInfo.docLabel}: ${clientInfo.dni}\n`;
        if (clientInfo.category === "installed") {
          text += "Instalada!";
        } else if (clientInfo.category === "programmed") {
          const scheduledTime = clientInfo.rowData[37] ? String(clientInfo.rowData[37]).trim() : "";
          let tramo = "";
          if (scheduledTime.startsWith("08")) tramo = "8 a 12";
          else if (scheduledTime.startsWith("12")) tramo = "12 a 4";
          else if (scheduledTime.startsWith("16") || scheduledTime.startsWith("4")) tramo = "4 a 8";
          else tramo = scheduledTime;
          text += `Programado para: ${clientInfo.rowData[36]} de ${tramo}`;
        } else if (clientInfo.category === "reviewed") {
          text += `Número de contacto: ${clientInfo.rowData[9] || ''}\nDistrito: ${clientInfo.rowData[13] || ''}\nLlamar a programar por favor`;
        } else if (clientInfo.category === "notInstalled") {
          const scheduledTime = clientInfo.rowData[37] ? String(clientInfo.rowData[37]).trim() : "";
          let tramo = "";
          if (scheduledTime.startsWith("08")) tramo = "8 a 12";
          else if (scheduledTime.startsWith("12")) tramo = "12 a 4";
          else if (scheduledTime.startsWith("16") || scheduledTime.startsWith("4")) tramo = "4 a 8";
          else tramo = scheduledTime;
          text += `Celular: ${clientInfo.rowData[9] || ''}\nDistrito: ${clientInfo.rowData[13] || ''}\nProgramado para: ${clientInfo.rowData[36]} de ${tramo}\nMe puede facilitar información del status de este cliente por favor`;
        } else if (clientInfo.category === "inProgress") {
          text += "En progreso";
        } else if (clientInfo.category === "desaprobados") {
          text += `${clientInfo.rowData[24] || ''} - ${clientInfo.rowData[25] || ''}`;
        }
        return text;
      }

      function processData(rows) {
        const now = new Date();
        function updateCount(categoryContainer) {
          categoryContainer.countSpan.textContent = " (" + categoryContainer.clientsContainer.childElementCount + ")";
        }
        const createCategoryContainer = (title, iconClass) => {
          const container = document.createElement('div');
          const header = document.createElement('h2');
          header.style.cursor = 'pointer';
          const categoryHeader = document.createElement('div');
          categoryHeader.classList.add('category-header');
          const iconSpan = document.createElement('span');
          iconSpan.className = `category-icon ${iconClass}`;
          iconSpan.setAttribute('aria-hidden', 'true');
          const titleSpan = document.createElement('span');
          titleSpan.textContent = title;
          const countSpan = document.createElement('span');
          countSpan.textContent = " (0)";
          countSpan.style.fontSize = "0.8em";
          countSpan.style.marginLeft = "10px";
          const toggleIndicator = document.createElement('span');
          toggleIndicator.style.fontSize = "0.8em";
          toggleIndicator.style.marginLeft = "10px";
          toggleIndicator.textContent = "Ocultar [-]";
          categoryHeader.appendChild(iconSpan);
          categoryHeader.appendChild(titleSpan);
          categoryHeader.appendChild(countSpan);
          categoryHeader.appendChild(toggleIndicator);
          header.appendChild(categoryHeader);
          const clientsContainer = document.createElement('div');
          clientsContainer.classList.add('clients-container');
          clientsContainer.style.display = 'flex';
          container.appendChild(header);
          container.appendChild(clientsContainer);
          header.addEventListener('click', () => {
            if (clientsContainer.style.display === 'none') {
              clientsContainer.style.display = 'flex';
              toggleIndicator.textContent = 'Ocultar [-]';
            } else {
              clientsContainer.style.display = 'none';
              toggleIndicator.textContent = 'Ver [+]';
            }
          });
          return { container, clientsContainer, countSpan };
        };

        const installed = createCategoryContainer("Clientes instalados", "fas fa-check-circle");
        const programmed = createCategoryContainer("Clientes programados", "fas fa-calendar-check");
        const reviewed = createCategoryContainer("Clientes revisados", "fas fa-search");
        const notInstalled = createCategoryContainer("Clientes no instalados", "fas fa-times-circle");
        const inProgress = createCategoryContainer("Clientes en progreso", "fas fa-spinner fa-spin");
        const desaprobados = createCategoryContainer("Clientes desaprobados", "fas fa-ban");

        const clientsData = [];
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          try {
            let nombre = row[7] || '';
            let dni = row[6] || '';
            let tipoDoc = (row[5] || '').trim().toLowerCase();
            let expectedLength = 0;
            let docLabel = "DNI";
            if (tipoDoc === "dni") {
              expectedLength = 8;
              docLabel = "DNI";
            } else if (tipoDoc === "carnet de extranjeria") {
              expectedLength = 9;
              docLabel = "C.E.";
            } else if (tipoDoc === "ruc") {
              expectedLength = 11;
              docLabel = "RUC";
            }
            dni = dni.toString();
            if (expectedLength > 0 && dni.length < expectedLength) {
              dni = dni.padStart(expectedLength, '0');
            }
            let statePedido = (row[24] || "").trim().toLowerCase();
            let estadoOrden = (row[27] || "").trim().toLowerCase();
            let category = "";
            if (estadoOrden === "ejecutada") {
              category = "installed";
            } else if (
              statePedido === "validado" &&
              estadoOrden === "programada" &&
              row[36] && row[37]
            ) {
              // Convertimos a cadena para evitar errores en .trim()
              const scheduledDateStr = row[36] ? String(row[36]).trim() : "";
              const scheduledTimeStr = row[37] ? String(row[37]).trim() : "";
              if (scheduledDateStr !== "" && scheduledTimeStr !== "") {
                const dateParts = scheduledDateStr.split("-");
                if (dateParts.length < 3) {
                  category = "desaprobados";
                } else {
                  const day = parseInt(dateParts[0], 10);
                  const month = parseInt(dateParts[1], 10) - 1;
                  const year = parseInt(dateParts[2], 10);
                  const timeParts = scheduledTimeStr.split(/[:\s]+/);
                  let hour = parseInt(timeParts[0], 10);
                  const minute = parseInt(timeParts[1], 10);
                  const second = parseInt(timeParts[2], 10);
                  if (timeParts.length > 3) {
                    const ampm = timeParts[3].toUpperCase();
                    if (ampm === "PM" && hour < 12) { hour += 12; }
                    if (ampm === "AM" && hour === 12) { hour = 0; }
                  }
                  const scheduledDateTime = new Date(year, month, day, hour, minute, second);
                  const scheduledEndTime = new Date(scheduledDateTime.getTime() + 4 * 60 * 60 * 1000);
                  category = (now <= scheduledEndTime) ? "programmed" : "notInstalled";
                }
              } else {
                category = "desaprobados";
              }
            } else if (statePedido === "revisado") {
              category = "reviewed";
            } else if (statePedido === "en progreso") {
              category = "inProgress";
            } else {
              category = "desaprobados";
            }
            clientsData.push({ rowData: row, category: category, nombre: nombre, dni: dni, docLabel: docLabel });
          } catch(err) {
            console.error(`Error procesando la fila ${i}: ${err}`);
          }
        }
        clientsData.sort((a, b) => a.nombre.localeCompare(b.nombre));
        clientsData.forEach(clientInfo => {
          const row = clientInfo.rowData;
          const category = clientInfo.category;
          const nombre = clientInfo.nombre;
          const dni = clientInfo.dni;
          const docLabel = clientInfo.docLabel;
          const clientDiv = document.createElement('div');
          clientDiv.classList.add('client-block');

          let contentHTML = `
            <p>Nombre: ${nombre}</p>
            <p>${docLabel}: <span class="dni" style="cursor: pointer; text-decoration: underline;">${dni}</span></p>
          `;
          if (category === "installed") {
            contentHTML += `<p>Instalada!</p>`;
          } else if (category === "programmed") {
            const scheduledTime = row[37] ? String(row[37]).trim() : "";
            let tramo = "";
            if (scheduledTime.startsWith("08")) { tramo = "8 a 12"; }
            else if (scheduledTime.startsWith("12")) { tramo = "12 a 4"; }
            else if (scheduledTime.startsWith("16") || scheduledTime.startsWith("4")) { tramo = "4 a 8"; }
            else { tramo = scheduledTime; }
            contentHTML += `<p>Programado para: ${row[36]} de ${tramo}</p>`;
          } else if (category === "reviewed") {
            contentHTML += `
              <p>Número de contacto: ${row[9] || ''}</p>
              <p>Distrito: ${row[13] || ''}</p>
              <p>Llamar a programar por favor</p>
            `;
          } else if (category === "notInstalled") {
            const scheduledTime = row[37] ? String(row[37]).trim() : "";
            let tramo = "";
            if (scheduledTime.startsWith("08")) { tramo = "8 a 12"; }
            else if (scheduledTime.startsWith("12")) { tramo = "12 a 4"; }
            else if (scheduledTime.startsWith("16") || scheduledTime.startsWith("4")) { tramo = "4 a 8"; }
            else { tramo = scheduledTime; }
            contentHTML += `
              <p>Celular: ${row[9] || ''}</p>
              <p>Distrito: ${row[13] || ''}</p>
              <p>Programado para: ${row[36]} de ${tramo}</p>
              <p>Me puede facilitar información del status de este cliente por favor</p>
            `;
          } else if (category === "inProgress") {
            contentHTML += `<p>En progreso</p>`;
          } else if (category === "desaprobados") {
            contentHTML += `<p>${row[24] || ''} - ${row[25] || ''}</p>`;
          }
          clientDiv.innerHTML = contentHTML;

          // Evento para copiar el DNI
          const dniSpan = clientDiv.querySelector('.dni');
          dniSpan.addEventListener('click', () => {
            const originalText = dniSpan.textContent;
            navigator.clipboard.writeText(originalText)
              .then(() => {
                dniSpan.textContent = "copiado";
                setTimeout(() => { dniSpan.textContent = originalText; }, 1000);
              })
              .catch(err => { alert(`Error al copiar el ${docLabel}.`); });
          });

          // Botones de acción
          const buttonsContainer = document.createElement('div');
          buttonsContainer.classList.add('client-buttons');

          const copyButton = document.createElement('button');
          copyButton.textContent = 'Copiar';
          if (isCopied(dni)) {
            copyButton.textContent = '✔ Copiado!';
            copyButton.style.backgroundColor = "#4CAF50";
            clientDiv.style.opacity = "0.5";
            copyButton.dataset.copied = "true";
          } else {
            copyButton.dataset.copied = "false";
          }
          buttonsContainer.appendChild(copyButton);

          copyButton.addEventListener('click', () => {
            if (copyButton.dataset.copied === "true") {
              copyButton.textContent = 'Copiar';
              copyButton.style.backgroundColor = "#6c63ff";
              clientDiv.style.opacity = "1";
              copyButton.dataset.copied = "false";
              setCopiedState(dni, false);
            } else {
              const textToCopy = getClientCopyText(clientInfo);
              navigator.clipboard.writeText(textToCopy)
                .then(() => {
                  copyButton.textContent = '✔ Copiado!';
                  copyButton.style.backgroundColor = "#4CAF50";
                  clientDiv.style.opacity = "0.5";
                  copyButton.dataset.copied = "true";
                  setCopiedState(dni, true);
                })
                .catch(err => { alert("Error al copiar el texto."); });
            }
          });

          const derivarButton = document.createElement('button');
          if (isDniDerived(dni)) {
            derivarButton.textContent = 'Derivado ✓';
            clientDiv.classList.add('derivado');
          } else {
            derivarButton.textContent = 'Derivado';
          }
          derivarButton.addEventListener('click', () => {
            if (isDniDerived(dni)) {
              removeDerivedDni(dni);
              derivarButton.textContent = 'Derivado';
              clientDiv.classList.remove('derivado');
            } else {
              saveDerivedDni(dni);
              derivarButton.textContent = 'Derivado ✓';
              clientDiv.classList.add('derivado');
            }
          });
          buttonsContainer.appendChild(derivarButton);
          clientDiv.appendChild(buttonsContainer);

          // Notas
          const notesContainer = document.createElement('div');
          notesContainer.className = 'client-notes-container';
          notesContainer.innerHTML = `<p style="margin-bottom: 5px;">Notas:</p>`;
          const noteData = getNoteDataForDni(dni);
          let noteElement = createNoteElement(noteData.note, noteData.timestamp);
          noteElement.dataset.dni = dni;
          noteElement.addEventListener('click', function(e) {
            openNoteModal(dni, noteElement);
          });
          notesContainer.appendChild(noteElement);
          clientDiv.appendChild(notesContainer);

          if (category === "installed") { installed.clientsContainer.appendChild(clientDiv); updateCount(installed); }
          else if (category === "programmed") { programmed.clientsContainer.appendChild(clientDiv); updateCount(programmed); }
          else if (category === "reviewed") { reviewed.clientsContainer.appendChild(clientDiv); updateCount(reviewed); }
          else if (category === "notInstalled") { notInstalled.clientsContainer.appendChild(clientDiv); updateCount(notInstalled); }
          else if (category === "inProgress") { inProgress.clientsContainer.appendChild(clientDiv); updateCount(inProgress); }
          else if (category === "desaprobados") { desaprobados.clientsContainer.appendChild(clientDiv); updateCount(desaprobados); }
        });
        const resultsContainer = document.getElementById('results');
        resultsContainer.innerHTML = '';
        resultsContainer.appendChild(installed.container);
        resultsContainer.appendChild(programmed.container);
        resultsContainer.appendChild(reviewed.container);
        resultsContainer.appendChild(notInstalled.container);
        resultsContainer.appendChild(inProgress.container);
        resultsContainer.appendChild(desaprobados.container);
        applySearchFilter();
      }

      function createNoteElement(note, timestamp) {
        const container = document.createElement('div');
        container.classList.add('client-notes');
        let truncated = note;
        if (note.length > 20) { truncated = note.substring(0,20) + "..."; }
        const contentSpan = document.createElement('span');
        contentSpan.classList.add('note-content');
        contentSpan.textContent = truncated;
        container.appendChild(contentSpan);
        if (timestamp) {
          const tsSpan = document.createElement('span');
          tsSpan.className = "note-timestamp";
          tsSpan.textContent = `(${timestamp})`;
          container.appendChild(tsSpan);
        }
        return container;
      }

      function openNoteModal(dni, noteElement) {
        const modal = document.getElementById('note-modal');
        const textarea = document.getElementById('note-modal-textarea');
        const timestampDiv = document.getElementById('note-modal-timestamp');
        const saveButton = document.getElementById('note-modal-save');
        const closeButton = document.getElementById('note-modal-close');
        const closeSpan = document.querySelector('.close-button');
        const noteData = getNoteDataForDni(dni);
        textarea.value = noteData.note;
        timestampDiv.textContent = noteData.timestamp ? `Última modificación: ${noteData.timestamp}` : "";
        modal.style.display = "block";

        function closeModal() {
          modal.style.display = "none";
          saveButton.removeEventListener('click', saveHandler);
          closeButton.removeEventListener('click', closeModal);
          closeSpan.removeEventListener('click', closeModal);
        }
        function saveHandler() {
          const newNote = textarea.value;
          saveNotesForDni(dni, newNote);
          const newData = getNoteDataForDni(dni);
          const newNoteElement = createNoteElement(newData.note, newData.timestamp);
          newNoteElement.dataset.dni = dni;
          newNoteElement.addEventListener('click', function(e) {
            openNoteModal(dni, newNoteElement);
          });
          noteElement.parentNode.replaceChild(newNoteElement, noteElement);
          closeModal();
        }
        saveButton.addEventListener('click', saveHandler);
        closeButton.addEventListener('click', closeModal);
        closeSpan.addEventListener('click', closeModal);
        window.onclick = function(event) {
          if (event.target == modal) { closeModal(); }
        };
      }

      // Filtro de búsqueda
      const searchInput = document.getElementById('search-input');
      function applySearchFilter() {
        const searchTerm = searchInput.value.toLowerCase();
        document.querySelectorAll('.clients-container').forEach(container => {
          container.childNodes.forEach(clientBlock => {
            const blockText = clientBlock.textContent.toLowerCase();
            clientBlock.style.display = blockText.includes(searchTerm) ? '' : 'none';
          });
        });
      }
      searchInput.addEventListener('input', applySearchFilter);
    });
  </script>
</body>
</html>
